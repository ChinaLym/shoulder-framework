# shoulder-auth-token

封装了 spring-security，支持 web（http）/ 服务端 的认证功能以及自动装配，

适用场景：前后端分离、APP/小程序后端、无状态系统 / 服务之间调用授权
- 如：前端使用 nodeJs 部署
      - Token来源-自签：常用于单机/集群
      - Token来源-独立的授权服务器：分布式（+ 服务集群）
          
提供能力          
- 提供了默认的登录页面
- 支持单点登录 `SSO`
- `session` 支持在集群模式自动切换为 `redis` 存储

- 通过第三方认证
    - SSO 通过
    - `OAuth2/OIDC`

- 授权
    - Oauth2 单机/集群
    
默认情况下 `token` 以内存存储，可通过 `cluster=true` 切换至集群模式，自动将存储转移至 `redis`（也可替换为其他，如`JDBC`）

----------

# 场景分析与设计方案

## 授权模式

| 模式名称 | 安全 | 授权决定方 | 适用场景 |
| --- | --- | --- | --- |
| 授权码模式 | 最繁琐、最安全 | 第三方应用申请的 `ClientDetail` 权限与用户勾选同意的权限取交集 | client是Web服务器端应用，或第三方的原生App调用资源服务的时候。因为在这种模式中 AccessToken 不会经过用户端（浏览器或移动端的App），而是直接从服务端去交换，这样就最大限度的减小了AccessToken因在客户端中传递而造成泄漏的风险（某黑客无法再针对一个第三方用户）。 |
| 简化模式 | 一般 | 第三方应用申请的 `ClientDetail` 权限与用户勾选同意的权限取交集 | 没有服务器端的第三方单页面应用，因为没有服务器端就无法回调，不能使用授权码模式。AccessToken 在客户端，可能造成泄露或劫持。 |
| 密码模式 | 简单、不安全 | 全授权/资源服务器针对用户、角色做一点限制 | 自己开发的，第一方原生App或第一方单页面应用（前后分离的WEB前端）。 |
| 客户端模式 | 最简单但最不安全 | 全授权/资源服务器针对调用方限制 | 适用该方案，表示对客户端完全可信，主要提供完全信任的内部系统服务器端服务。在这个过程无需要用户的参与。 |


## 利用 Oauth2 + JWT 认证（OIDC）

### BOOT：单机/集群 系统 【本模块支持场景】

认证、授权、鉴权均在一个系统中，故可以合为一个整体需求

#### 需求

- 发放token
    - 作为**授权服务**（登录认证成功后授予 `token`）
- 调用认证服务器验证 token
    - 作为**资源服务**（单机/集群场景可替换默认的 `OpaqueTokenIntrospector`，减少请求）


#### 方案

引入 `shoulder-starter-auth-token`

---

### ~~CLOUD：分布式系统~~

由单独的授权服务器发放 `token`，其余服务在被调用时不直接提供，而会先校验 token

#### 需求

- **授权服务**
    - 发放 `token`

- 其他无状态服务
    - 调用认证服务器验证 token（作为 **资源服务** ）
    - 调用其他资源服务器（作为 **客户端** ）
    
#### ~~方案~~

~~授权服务使用~~ `shoulder-starter-auth-server`

**分布式系统的解决方案与开箱即用的代码由 `shoulder-platform` 提供**

----

## 第三方授权

如需要调用 Google、Github、QQ 等服务的 API

### 需求

作为 Oauth2 客户端，在调用其他服务接口时自动补充 token

维护token的完整步骤包含

- 根据 appId、appSecret 获取 token 接口
- 维护 token：存储、自动刷新、支持手动刷新、接口响应错误刷新、保证 token 的存储安全
- 在接口调用前，自动增加 `accessToken`、若没有、过期则调用响应的获取/刷新接口
- 上述流程支持同时存在多个外部服务


### 结论

单机/集群场景或分布式中的`第三方服务网关`需要实现上述能力，区别在于可能是`web`、也可能是`webflux`需求类似。`Shoulder` 框架采用 `Spring Security` 方案，不区分对待，仅支持 `WebClient`


### 第三方登录

第三方登录仅仅是在调用第三方获取用户信息接口基础上，自动创建用户并完成登录，故与第三方授权类似，主要是多了根据第三方用户信息创建用户操作。

由于创建用户的逻辑多种多样，在 `shoulder-platform` 中实现


---

特殊需求：

前后端不分离、单机/集群部署，又需要同时支持浏览器端（Session认证）、APP端（token认证）

关键点：需要登录时，如何区分是跳转到登录页（或登录提示页），还是返回一个特定的 Json，提示客户端需要先认证。

方案：

- 由于不需要考虑伪造 `user-agent`，故可以根据了浏览器特有标识识别
    - User-Agent 中以 `Mozilla` 开头，不是 ajax 请求
- 让客户端携带特定标识，如 `deviceId`


## JWT JWK 选择

若为开放使用，则推荐使用 jwk，若为内部使用，推荐使用 jwt


