# shoulder-auth-token

封装了 spring-security，支持 web（http）/ 服务端 的认证功能以及自动装配，

适用场景：前后端分离、APP/小程序后端、无状态服务端之间认证。
- 如：前端使用 nodeJs 部署
      - 自签 Token，常用于单机/集群
      - SSO：分布式
          - 分布式 + 服务集群
          
提供能力          
- 提供了默认的登录页面
- 支持单点登录 `SSO`
- `session` 支持在集群模式自动切换为 `redis` 存储

- 通过第三方认证
    - SSO 通过
    - `OAuth2/OIDC`

- 授权
    - Oauth2 单机/集群
    
默认情况下 `token` 以内存存储，可通过 `cluster=true` 切换至集群模式，自动将存储转移至 `redis`（也可替换为其他，如`JDBC`）

----------

# 场景分析与设计方案


## 利用 Oauth2 + JWT 认证（OIDC）

### BOOT：单机/集群 系统 【本模块支持场景】

认证、授权、鉴权均在一个系统中，故可以合为一个整体需求

#### 需求

- 发放token
    - 作为**授权服务**（登录认证成功后授予 `token`）
- 调用认证服务器验证 token
    - 作为**资源服务**（单机/集群场景可替换默认的 `OpaqueTokenIntrospector`，减少请求）


#### 方案

引入 `shoulder-starter-auth-token`

---

### ~~CLOUD：分布式系统~~

由单独的授权服务器发放 `token`，其余服务在被调用时不直接提供，而会先校验 token

#### 需求

- **授权服务**
    - 发放 `token`

- 其他无状态服务
    - 调用认证服务器验证 token（作为 **资源服务** ）
    - 调用其他资源服务器（作为 **客户端** ）
    
#### ~~方案~~

~~授权服务使用~~ `shoulder-starter-auth-server`

**分布式系统的解决方案与开箱即用的代码由 `shoulder-platform` 提供**

----

## 第三方授权

如需要调用 Google、Github、QQ 等服务的 API

### 需求

作为 Oauth2 客户端，在调用其他服务接口时自动补充 token

维护token的完整步骤包含

- 根据 appId、appSecret 获取 token 接口
- 维护 token：存储、自动刷新、支持手动刷新、接口响应错误刷新、保证 token 的存储安全
- 在接口调用前，自动增加 `accessToken`、若没有、过期则调用响应的获取/刷新接口
- 上述流程支持同时存在多个外部服务


### 结论

单机/集群场景或分布式中的`第三方服务网关`需要实现上述能力，区别在于可能是`web`、也可能是`webflux`需求类似。`Shoulder` 框架采用 `Spring Security` 方案，不区分对待，仅支持 `WebClient`


### 第三方登录

第三方登录仅仅是在调用第三方获取用户信息接口基础上，自动创建用户并完成登录，故与第三方授权类似，主要是多了根据第三方用户信息创建用户操作。

由于创建用户的逻辑多种多样，在 `shoulder-platform` 中实现


---

特殊需求：

前后端不分离、单机/集群部署，又需要同时支持浏览器端（Session认证）、APP端（token认证）

关键点：需要登录时，如何区分是跳转到登录页（或登录提示页），还是返回一个特定的 Json，提示客户端需要先认证。

方案：

- 由于不需要考虑伪造 `user-agent`，故可以根据了浏览器特有标识识别
    - User-Agent 中以 `Mozilla` 开头，不是 ajax 请求
- 让客户端携带特定标识，如 `deviceId`


## JWT JWK 选择

若为开放使用，则推荐使用 jwk，若为内部使用，推荐使用 jwt


